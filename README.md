# @justinhaaheim/version-manager

A file-based version tracking system for JavaScript/TypeScript projects. Automatically calculates version numbers based on git commit history since your last manual version bump.

## Features

- **File-based versioning**: Uses `version-manager.json` as source of truth (committed to repo)
- **Automatic version calculation**: Tracks commits since last `codeVersionBase` change
- **Two calculation modes**:
  - `add-to-patch`: Adds commit count to patch version (e.g., 1.3.0 + 5 commits → 1.3.5)
  - `append-commits`: Appends commit count as metadata (e.g., 1.3.0 + 5 commits → 1.3.0+5)
- **Git hooks integration**: Auto-generates version file on commits, checkouts, merges, rebases
- **Build hooks**: Auto-regenerates version before `npm run build`, `dev`, and `start`
- **Runtime version support**: Track OTA update compatibility separately from code version
- **Zero runtime dependencies**: Uses only Node.js built-ins for fast installation

## Installation

```bash
npx @justinhaaheim/version-manager install
```

This will:

- Create `version-manager.json` (committed - your version configuration)
- Install git hooks that auto-regenerate versions on git operations
- Add npm scripts to your `package.json` for manual regeneration
- Generate `dynamic-version.local.json` (gitignored - computed versions)
- Add `*.local.json` to your `.gitignore`

## Quick Start

1. **Install** (one-time setup):

   ```bash
   npx @justinhaaheim/version-manager install
   ```

2. **Use in your code**:

   ```typescript
   // Import the reader
   import {readDynamicVersion} from '@justinhaaheim/version-manager/reader';

   // Get version info
   const {codeVersion, runtimeVersion, buildNumber} = readDynamicVersion();
   console.log(`App version: ${codeVersion}`);
   ```

3. **Bump versions when ready**:

   ```bash
   # Bump patch version (0.1.5 → 0.1.6)
   npx @justinhaaheim/version-manager bump --commit

   # Bump minor version (0.1.6 → 0.2.0)
   npx @justinhaaheim/version-manager bump --minor --commit --tag
   ```

## How It Works

### Version Files

**`version-manager.json`** (committed to git):

```json
{
  "codeVersionBase": "0.1.0",
  "runtimeVersion": "0.1.0",
  "versionCalculationMode": "add-to-patch"
}
```

- This is your source of truth
- Edit `codeVersionBase` when you want to bump the base version
- The tool counts commits since the last time this value changed

**`dynamic-version.local.json`** (gitignored, auto-generated):

```json
{
  "codeVersion": "0.1.5",
  "runtimeVersion": "0.1.0",
  "buildNumber": "20251021.123456.789",
  "timestamp": "2025-10-21T12:34:56.789Z",
  "generationTrigger": "post-commit",
  "branch": "main",
  "dirty": false
}
```

- Automatically regenerated by git hooks and build scripts
- Never commit this file
- Contains the computed `codeVersion` based on commits since last bump

### Version Calculation

The tool uses git history to calculate versions automatically:

1. Reads `codeVersionBase` from `version-manager.json` (e.g., "0.1.0")
2. Finds the last commit where `codeVersionBase` **value** changed
3. Counts commits from that point to HEAD (e.g., 5 commits)
4. Calculates `codeVersion` based on your mode:
   - **`add-to-patch`**: `0.1.0` + 5 commits → `0.1.5`
   - **`append-commits`**: `0.1.0` + 5 commits → `0.1.0+5`

## Commands

### 1. Generate Version File (default)

```bash
npx @justinhaaheim/version-manager [options]
```

Generates `dynamic-version.local.json` with computed versions.

**Options:**

- `--output, -o <path>`: Output file path (default: ./dynamic-version.local.json)
- `--silent, -s`: Suppress console output
- `--fail/--no-fail`: Exit with error code on failures (default: true)

**Example:**

```bash
npx @justinhaaheim/version-manager
npx @justinhaaheim/version-manager --output ./src/version.json
```

### 2. Install Git Hooks and Scripts

```bash
npx @justinhaaheim/version-manager install [options]
```

Installs git hooks and adds npm scripts to your `package.json`.

**Git hooks installed:**

- `post-commit` - Regenerate version after commits
- `post-checkout` - Regenerate version after branch switches
- `post-merge` - Regenerate version after merges
- `post-rewrite` - Regenerate version after rebases

**Scripts added to package.json:**

- `dynamic-version:generate` - Generate version file manually
- `dynamic-version:install` - Reinstall git hooks
- `dynamic-version:install-scripts` - Update scripts only
- `prebuild` - Auto-regenerate version before `npm run build`
- `predev` - Auto-regenerate version before `npm run dev`
- `prestart` - Auto-regenerate version before `npm run start`

**Options:**

- `--silent, -s`: Suppress console output
- `--fail/--no-fail`: Exit with error code on failures

### 3. Bump Version

```bash
npx @justinhaaheim/version-manager bump [options]
```

Increments the version in `version-manager.json` based on the current computed version.

**Options:**

- `--major`: Bump major version (e.g., 1.2.3 → 2.0.0)
- `--minor`: Bump minor version (e.g., 1.2.3 → 1.3.0)
- `--patch`: Bump patch version (e.g., 1.2.3 → 1.2.4) - **default**
- `--runtime, -r`: Also update runtimeVersion to match codeVersion
- `--commit, -c`: Auto-commit the version change
- `--tag, -t`: Create git tag (requires --commit)
- `--push, -p`: Push commit and tag to remote (requires --commit)
- `--message, -m <msg>`: Custom commit message (only with --commit)

**Examples:**

```bash
# Bump patch version (default)
npx @justinhaaheim/version-manager bump

# Bump minor version and commit
npx @justinhaaheim/version-manager bump --minor --commit

# Bump major, commit, tag, and push
npx @justinhaaheim/version-manager bump --major --commit --tag --push

# Bump and update runtime version too
npx @justinhaaheim/version-manager bump --minor --runtime --commit

# Short form
npx @justinhaaheim/version-manager bump -c -t -p
```

### 4. Install Scripts Only

```bash
npx @justinhaaheim/version-manager install-scripts
```

Only updates `package.json` scripts (doesn't touch git hooks). Useful if you want to update scripts after package upgrades.

## Version Types

### Code Version (`codeVersion`)

The automatically calculated application version based on git commit history.

- **Format**: Semantic versioning (e.g., `0.1.5` or `0.1.0+5`)
- **Calculated from**: Commits since last `codeVersionBase` change
- **Used for**: App version display, tracking deployments

### Runtime Version (`runtimeVersion`)

Defines the native runtime compatibility boundary for over-the-air (OTA) updates.

- **Format**: Semantic versioning (e.g., `1.0.0`)
- **When to update**: Only when making breaking native changes
- **Used for**: OTA update compatibility (Expo/React Native)
- **Breaking changes include**:
  - Adding/removing native dependencies
  - Changing app permissions
  - Modifying native configuration
  - Updating SDK versions

### Build Number (`buildNumber`)

Optional build identifier from `BUILD_NUMBER` environment variable.

- **Format**: Timestamp or CI build number (e.g., `20251021.123456.789`)
- **When set**: Include `BUILD_NUMBER` env var when generating
- **Used for**: Build tracking, CI/CD pipelines

## Usage Examples

### In React/React Native

```typescript
import { readDynamicVersion } from '@justinhaaheim/version-manager/reader';

const { codeVersion, runtimeVersion } = readDynamicVersion();

export function VersionDisplay() {
  return (
    <div style={{
      position: 'fixed',
      bottom: 4,
      right: 4,
      fontSize: 11,
      fontFamily: 'monospace',
      background: 'rgba(0,0,0,0.8)',
      color: '#00ff00',
      padding: '2px 8px',
      borderRadius: 3,
    }}>
      v{codeVersion}
    </div>
  );
}
```

### In Expo/React Native `app.config.js`

```javascript
const {readDynamicVersion} = require('@justinhaaheim/version-manager/reader');

const {codeVersion, runtimeVersion, buildNumber} = readDynamicVersion();

module.exports = {
  expo: {
    name: 'My App',
    version: codeVersion,
    runtimeVersion: runtimeVersion,
    ios: {
      buildNumber: buildNumber || '1',
    },
    android: {
      versionCode: parseInt(buildNumber || '1'),
    },
  },
};
```

### In CI/CD

```yaml
# GitHub Actions
- name: Set build number
  run: echo "BUILD_NUMBER=$(date +%Y%m%d.%H%M%S.%N | cut -b1-20)" >> $GITHUB_ENV

- name: Generate version
  run: npx @justinhaaheim/version-manager

- name: Build app
  run: npm run build
```

### In package.json scripts

The `install` command adds these scripts automatically:

```json
{
  "scripts": {
    "dynamic-version:generate": "npx @justinhaaheim/version-manager",
    "dynamic-version:install": "npx @justinhaaheim/version-manager install",
    "dynamic-version:install-scripts": "npx @justinhaaheim/version-manager install-scripts",
    "prebuild": "npm run dynamic-version:generate -- --silent --no-fail",
    "predev": "npm run dynamic-version:generate -- --silent --no-fail",
    "prestart": "npm run dynamic-version:generate -- --silent --no-fail"
  }
}
```

## Version Calculation Modes

### `add-to-patch` (recommended)

Adds the commit count to the patch version number.

**Example:**

- `codeVersionBase`: `1.3.0`
- Commits since last change: `5`
- **Result**: `1.3.5`

Best for projects that want natural semver progression.

### `append-commits`

Appends the commit count as build metadata.

**Example:**

- `codeVersionBase`: `1.3.0`
- Commits since last change: `5`
- **Result**: `1.3.0+5`

Best for pre-release/dev builds where you want to see commit count explicitly.

## TypeScript Support

The package includes full TypeScript definitions. For the generated file:

```typescript
// Add to your project's types
declare module '*/dynamic-version.local.json' {
  interface DynamicVersion {
    codeVersion: string;
    runtimeVersion: string;
    buildNumber?: string;
    timestamp?: string;
    generationTrigger?: string;
    branch?: string;
    dirty?: boolean;
  }

  const version: DynamicVersion;
  export default version;
}
```

## Git Hooks Management

The tool intelligently manages git hooks:

- Detects Husky and adjusts hook format accordingly
- Smart updates: appends to new hooks, replaces matching lines in existing hooks
- Respects `core.hooksPath` git config
- Makes hooks executable automatically
- Won't duplicate hook commands

To bypass hooks temporarily:

```bash
git commit --no-verify
```

## Troubleshooting

### Version file not updating

Make sure git hooks are installed:

```bash
npx @justinhaaheim/version-manager install
```

### Missing .gitignore entry

The tool will prompt you to add `*.local.json` to `.gitignore`. You can add it manually:

```bash
echo "*.local.json" >> .gitignore
```

### Reading version file fails

Make sure you've generated it at least once:

```bash
npx @justinhaaheim/version-manager
```

### Git hooks not working with Husky

The tool detects Husky automatically. If you have issues, try reinstalling:

```bash
npx @justinhaaheim/version-manager install
```

## Migration from Other Systems

### From tag-based versioning

If you're using git tags like `v1.2.3`:

1. Find your latest tag: `git describe --tags --abbrev=0`
2. Set that as your `codeVersionBase` in `version-manager.json`
3. Future versions will calculate from there

### From manual versioning

1. Set your current version in `version-manager.json`
2. Run `npx @justinhaaheim/version-manager install`
3. Versions will auto-increment from there

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

MIT © Justin Haaheim

## See Also

- [CLAUDE.md](./CLAUDE.md) - Development instructions and codebase overview
